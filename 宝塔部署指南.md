# 赞赞星项目宝塔部署指南

## 项目概述

赞赞星氛围营造工具是一个基于 React + Node.js 的全栈应用，包含前端管理界面和后端API服务。

### 技术栈
- **前端**: React 18 + Ant Design + Webpack
- **后端**: Node.js + Express + Prisma
- **数据库**: MySQL/PostgreSQL
- **部署**: 宝塔面板 + Nginx

## 一、服务器环境准备

### 1.1 系统要求
- **操作系统**: CentOS 7+ / Ubuntu 18+ / Debian 9+
- **内存**: 最低 2GB，推荐 4GB+
- **硬盘**: 最低 20GB 可用空间
- **网络**: 公网IP，开放 80、443、8888 端口

### 1.2 安装宝塔面板
```bash
# CentOS 安装命令
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec

# Ubuntu/Debian 安装命令
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

### 1.3 宝塔面板基础配置
1. 访问 `http://你的服务器IP:8888`
2. 完成宝塔面板初始化设置
3. 安装推荐套件：
   - **Nginx**: 1.20+
   - **MySQL**: 5.7+ 或 8.0+
   - **Node.js**: 16+ (通过软件商店安装)
   - **PM2**: 进程管理器

## 二、项目文件部署

### 2.1 上传项目文件
1. 在宝塔面板中创建网站目录：
   ```
   /www/wwwroot/praisestar.com
   ```

2. 将项目文件上传到服务器：
   ```bash
   # 方式1: 使用宝塔文件管理器上传
   # 方式2: 使用Git克隆
   git clone https://github.com/your-repo/praisestar.git /www/wwwroot/praisestar.com
   
   # 方式3: 使用SCP上传
   scp -r ./PraiseStar root@your-server-ip:/www/wwwroot/praisestar.com
   ```

### 2.2 项目目录结构
```
/www/wwwroot/praisestar.com/
├── frontend/                 # 前端项目
│   ├── src/
│   ├── package.json
│   ├── webpack.config.js
│   └── dist/                # 构建后的文件
├── backend/                  # 后端项目
│   ├── src/
│   ├── package.json
│   ├── prisma/
│   └── .env
├── nginx.conf               # Nginx配置
└── ecosystem.config.js      # PM2配置
```

## 三、后端部署

### 3.1 安装Node.js依赖
```bash
cd /www/wwwroot/praisestar.com/backend
npm install --production
```

### 3.2 配置环境变量
创建 `.env` 文件：
```bash
# 数据库配置
DATABASE_URL="mysql://username:password@localhost:3306/praisestar"

# JWT配置
JWT_SECRET="your-super-secret-jwt-key"
JWT_EXPIRES_IN="7d"

# 服务器配置
PORT=3000
NODE_ENV=production

# 文件上传配置
UPLOAD_PATH="/www/wwwroot/praisestar.com/uploads"
MAX_FILE_SIZE=5242880

# 邮件配置（可选）
SMTP_HOST="smtp.example.com"
SMTP_PORT=587
SMTP_USER="your-email@example.com"
SMTP_PASS="your-email-password"
```

### 3.3 数据库初始化
```bash
# 生成Prisma客户端
npx prisma generate

# 运行数据库迁移
npx prisma db push

# 可选：填充初始数据
npx prisma db seed
```

### 3.4 创建PM2配置文件
创建 `ecosystem.config.js`：
```javascript
module.exports = {
  apps: [{
    name: 'praisestar-api',
    script: './src/app.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: '/www/wwwroot/praisestar.com/logs/err.log',
    out_file: '/www/wwwroot/praisestar.com/logs/out.log',
    log_file: '/www/wwwroot/praisestar.com/logs/combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max_old_space_size=1024'
  }]
}
```

### 3.5 启动后端服务
```bash
# 使用PM2启动
pm2 start ecosystem.config.js

# 设置开机自启
pm2 startup
pm2 save
```

## 四、前端部署

### 4.1 安装前端依赖
```bash
cd /www/wwwroot/praisestar.com/frontend
npm install
```

### 4.2 修改生产环境配置
修改 `src/services/config.js`：
```javascript
export const API_CONFIG = {
  BASE_URL: 'https://api.praisestar.com/api',  // 修改为你的API域名
  // ... 其他配置保持不变
}
```

### 4.3 构建前端项目
```bash
npm run build
```

构建完成后，`dist` 目录将包含所有静态文件。

## 五、Nginx配置

### 5.1 创建Nginx配置文件
在宝塔面板中创建站点，并配置Nginx：

```nginx
server {
    listen 80;
    server_name praisestar.com www.praisestar.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name praisestar.com www.praisestar.com;
    
    # SSL证书配置
    ssl_certificate /www/server/panel/vhost/cert/praisestar.com/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/praisestar.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_prefer_server_ciphers on;
    
    # 前端静态文件
    location / {
        root /www/wwwroot/praisestar.com/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 静态资源缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 文件上传
    location /uploads/ {
        alias /www/wwwroot/praisestar.com/uploads/;
        expires 1y;
        add_header Cache-Control "public";
    }
    
    # 安全配置
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # 日志配置
    access_log /www/wwwlogs/praisestar.com.log;
    error_log /www/wwwlogs/praisestar.com.error.log;
}
```

### 5.2 配置SSL证书
1. 在宝塔面板中申请Let's Encrypt免费SSL证书
2. 或上传自己的SSL证书文件

## 六、数据库配置

### 6.1 创建数据库
在宝塔面板中：
1. 进入数据库管理
2. 创建新数据库：`praisestar`
3. 创建数据库用户并授权

### 6.2 配置数据库连接
确保后端 `.env` 文件中的数据库连接字符串正确：
```bash
DATABASE_URL="mysql://数据库用户名:密码@localhost:3306/praisestar"
```

## 七、文件权限配置

### 7.1 设置目录权限
```bash
# 设置项目目录权限
chown -R www:www /www/wwwroot/praisestar.com
chmod -R 755 /www/wwwroot/praisestar.com

# 设置上传目录权限
mkdir -p /www/wwwroot/praisestar.com/uploads
chown -R www:www /www/wwwroot/praisestar.com/uploads
chmod -R 755 /www/wwwroot/praisestar.com/uploads

# 设置日志目录权限
mkdir -p /www/wwwroot/praisestar.com/logs
chown -R www:www /www/wwwroot/praisestar.com/logs
chmod -R 755 /www/wwwroot/praisestar.com/logs
```

## 八、防火墙配置

### 8.1 开放必要端口
在宝塔面板安全设置中开放：
- **80**: HTTP
- **443**: HTTPS
- **8888**: 宝塔面板（可选，建议修改默认端口）
- **3000**: 后端API（仅内网访问）

### 8.2 配置安全组
如果使用云服务器，在云服务商控制台配置安全组规则。

## 九、域名解析

### 9.1 配置DNS解析
在域名服务商处添加A记录：
```
类型: A
主机记录: @
记录值: 你的服务器IP
TTL: 600

类型: A
主机记录: www
记录值: 你的服务器IP
TTL: 600

类型: A
主机记录: api
记录值: 你的服务器IP
TTL: 600
```

## 十、部署验证

### 10.1 检查服务状态
```bash
# 检查PM2进程
pm2 status

# 检查Nginx状态
systemctl status nginx

# 检查数据库连接
mysql -u用户名 -p -e "SHOW DATABASES;"
```

### 10.2 功能测试
1. **前端访问**: `https://praisestar.com`
2. **API测试**: `https://api.praisestar.com/api/health`
3. **登录功能**: 测试用户登录
4. **文件上传**: 测试图片上传功能
5. **数据库操作**: 测试增删改查功能

## 十一、性能优化

### 11.1 前端优化
```bash
# 启用Gzip压缩
# 在Nginx配置中添加：
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
```

### 11.2 后端优化
```javascript
// PM2配置优化
module.exports = {
  apps: [{
    name: 'praisestar-api',
    script: './src/app.js',
    instances: 'max',  // 使用所有CPU核心
    exec_mode: 'cluster',
    max_memory_restart: '1G',
    node_args: '--max_old_space_size=1024'
  }]
}
```

### 11.3 数据库优化
```sql
-- 创建必要的索引
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_stars_created_at ON stars(created_at);
CREATE INDEX idx_gifts_status ON gifts(status);
```

## 十二、监控与维护

### 12.1 日志监控
```bash
# 查看PM2日志
pm2 logs praisestar-api

# 查看Nginx日志
tail -f /www/wwwlogs/praisestar.com.log

# 查看错误日志
tail -f /www/wwwlogs/praisestar.com.error.log
```

### 12.2 定期备份
1. **数据库备份**: 在宝塔面板中设置自动备份
2. **文件备份**: 定期备份上传的文件
3. **代码备份**: 使用Git进行版本控制

### 12.3 更新部署
```bash
# 更新代码
cd /www/wwwroot/praisestar.com
git pull origin main

# 更新后端
cd backend
npm install
npx prisma generate
pm2 restart praisestar-api

# 更新前端
cd ../frontend
npm install
npm run build
# 重启Nginx
systemctl reload nginx
```

## 十三、常见问题解决

### 13.1 502 Bad Gateway
```bash
# 检查后端服务是否运行
pm2 status

# 检查端口是否被占用
netstat -tlnp | grep 3000

# 重启后端服务
pm2 restart praisestar-api
```

### 13.2 数据库连接失败
```bash
# 检查数据库服务
systemctl status mysql

# 检查数据库用户权限
mysql -u用户名 -p -e "SHOW GRANTS;"

# 测试数据库连接
mysql -u用户名 -p -h localhost praisestar
```

### 13.3 文件上传失败
```bash
# 检查上传目录权限
ls -la /www/wwwroot/praisestar.com/uploads

# 检查Nginx配置
nginx -t

# 检查文件大小限制
# 在Nginx配置中调整 client_max_body_size
```

### 13.4 SSL证书问题
```bash
# 检查证书文件
ls -la /www/server/panel/vhost/cert/praisestar.com/

# 重新申请证书
# 在宝塔面板中重新申请Let's Encrypt证书
```

## 十四、安全建议

### 14.1 服务器安全
1. 定期更新系统和软件包
2. 配置防火墙规则
3. 使用强密码
4. 禁用不必要的服务

### 14.2 应用安全
1. 定期更新依赖包
2. 使用HTTPS加密传输
3. 配置CORS策略
4. 实施访问控制

### 14.3 数据安全
1. 定期备份数据库
2. 加密敏感数据
3. 实施数据访问审计
4. 配置数据保留策略

## 十五、联系支持

如果在部署过程中遇到问题，可以：
1. 查看项目文档和README
2. 检查GitHub Issues
3. 联系技术支持团队

---

**部署完成后，您的赞赞星项目将在以下地址访问：**
- 前端: `https://praisestar.com`
- API: `https://api.praisestar.com/api`

祝您部署顺利！🎉
