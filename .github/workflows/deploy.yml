name: 自动部署

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: 安装依赖
      run: npm ci
    
    - name: 构建项目
      run: npm run build
    
    - name: 上传文件
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        source: "dist/*"
        target: "/tmp/praisestar-deploy/"
        strip_components: 1
    
    - name: 部署到服务器
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          DEPLOY_PATH="/www/wwwroot/39.105.117.48"
          TEMP_DIR="/tmp/praisestar-deploy"
          
          # 清空部署目录（保留备份和系统文件）
          cd $DEPLOY_PATH
          for item in *; do
            if [ "$item" != "backup" ] && [ "$item" != ".user.ini" ]; then
              rm -rf "$item" 2>/dev/null || true
            fi
          done
          
          # 复制文件
          if [ -d "$TEMP_DIR" ]; then
            cp -r $TEMP_DIR/* $DEPLOY_PATH/ 2>/dev/null || true
          fi
          
          # 设置权限
          chmod -R 755 $DEPLOY_PATH 2>/dev/null || true
          chown -R deploy:deploy $DEPLOY_PATH 2>/dev/null || true
          find $DEPLOY_PATH -type f -exec chmod 644 {} \; 2>/dev/null || true
          
          # 重启服务
          systemctl reload nginx 2>/dev/null || true
          
          # 清理临时文件
          rm -rf $TEMP_DIR 2>/dev/null || true
          
          echo "部署完成！访问地址：http://${{ secrets.DEPLOY_HOST }}/39.105.117.48"
 