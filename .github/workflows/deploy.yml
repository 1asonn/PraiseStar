name: è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        echo "æ­£åœ¨å®‰è£…ä¾èµ–..."
        npm ci
    
    - name: è¿è¡Œä»£ç æ£€æŸ¥
      run: |
        echo "è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
        npm audit --audit-level=high || echo "å®‰å…¨æ£€æŸ¥å®Œæˆï¼ˆæœ‰è­¦å‘Šï¼‰"
    
    - name: æ„å»ºé¡¹ç›®
      run: |
        echo "å¼€å§‹æ„å»ºé¡¹ç›®..."
        npm run build
        echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºæ–‡ä»¶..."
        ls -la dist/
        echo "æ„å»ºäº§ç‰©å¤§å°ï¼š"
        du -sh dist/
    
    - name: åˆ›å»ºéƒ¨ç½²åŒ…
      run: |
        echo "åˆ›å»ºéƒ¨ç½²åŒ…..."
        cd dist
        tar -czf ../praisestar-build-$(date +%Y%m%d_%H%M%S).tar.gz .
        cd ..
        echo "éƒ¨ç½²åŒ…åˆ›å»ºå®Œæˆï¼š"
        ls -lh *.tar.gz
    
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          echo "å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨..."
          
          # è®¾ç½®éƒ¨ç½²è·¯å¾„
          DEPLOY_PATH="/www/wwwroot/39.105.117.48"
          BACKUP_PATH="/www/wwwroot/39.105.117.48/backup"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
          echo "å¤‡ä»½è·¯å¾„: $BACKUP_PATH"
          
          # æ£€æŸ¥ç›®å½•æƒé™
          echo "æ£€æŸ¥ç›®å½•æƒé™..."
          ls -la /www/wwwroot/ || echo "æ— æ³•è®¿é—® /www/wwwroot/"
          ls -la /www/wwwroot/39.105.117.48/ || echo "æ— æ³•è®¿é—®ç›®æ ‡ç›®å½•"
          
          # åˆ›å»ºéƒ¨ç½²å’Œå¤‡ä»½ç›®å½•
          echo "åˆ›å»ºç›®å½•..."
          mkdir -p $DEPLOY_PATH
          mkdir -p $BACKUP_PATH
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦åˆ›å»ºæˆåŠŸ
          echo "æ£€æŸ¥ç›®å½•åˆ›å»ºç»“æœ..."
          ls -la $DEPLOY_PATH
          ls -la $BACKUP_PATH
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          echo "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
          if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH 2>/dev/null)" ]; then
            mkdir -p $BACKUP_PATH/backup_$TIMESTAMP
            cp -r $DEPLOY_PATH/* $BACKUP_PATH/backup_$TIMESTAMP/ 2>/dev/null || true
            echo "å¤‡ä»½å®Œæˆï¼š$BACKUP_PATH/backup_$TIMESTAMP"
            ls -la $BACKUP_PATH/backup_$TIMESTAMP
          else
            echo "ç›®æ ‡ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
          fi
          
          echo "å‡†å¤‡æ¥æ”¶æ–°ç‰ˆæœ¬æ–‡ä»¶..."
    
    - name: ä¸Šä¼ æ„å»ºæ–‡ä»¶
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        source: "dist/*"
        target: "/tmp/praisestar-deploy/"
        strip_components: 1
    
    - name: å®Œæˆéƒ¨ç½²
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          echo "å®Œæˆéƒ¨ç½²é…ç½®..."
          
          DEPLOY_PATH="/www/wwwroot/39.105.117.48"
          TEMP_DIR="/tmp/praisestar-deploy"
          
          echo "æ£€æŸ¥ä¸´æ—¶ç›®å½•å†…å®¹..."
          ls -la $TEMP_DIR || echo "ä¸´æ—¶ç›®å½•ä¸å­˜åœ¨"
          
          echo "æ£€æŸ¥éƒ¨ç½²ç›®å½•å½“å‰çŠ¶æ€..."
          ls -la $DEPLOY_PATH || echo "éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
          
          # ç§»åŠ¨æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
          echo "ç§»åŠ¨æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•..."
          # æ¸…ç©ºç›®æ ‡ç›®å½•ï¼ˆä¿ç•™å¤‡ä»½ç›®å½•å’Œç³»ç»Ÿæ–‡ä»¶ï¼‰
          echo "æ¸…ç©ºç›®æ ‡ç›®å½•..."
          cd $DEPLOY_PATH
          # åˆ é™¤æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•ï¼Œé™¤äº† backup å’Œ .user.ini
          for item in *; do
            if [ "$item" != "backup" ] && [ "$item" != ".user.ini" ]; then
              rm -rf "$item" 2>/dev/null || true
            fi
          done
          
          echo "å¤åˆ¶æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•..."
          cp -r $TEMP_DIR/* $DEPLOY_PATH/ 2>/dev/null || true
          
          echo "æ£€æŸ¥éƒ¨ç½²åçš„ç›®å½•å†…å®¹..."
          ls -la $DEPLOY_PATH
          
          # è®¾ç½®æƒé™
          echo "è®¾ç½®æ–‡ä»¶æƒé™..."
          chown -R nginx:nginx $DEPLOY_PATH 2>/dev/null || true
          chmod -R 644 $DEPLOY_PATH 2>/dev/null || true
          find $DEPLOY_PATH -type d -exec chmod 755 {} \; 2>/dev/null || true
          
          echo "æ£€æŸ¥æœ€ç»ˆæƒé™è®¾ç½®..."
          ls -la $DEPLOY_PATH
          
          # é‡å¯æœåŠ¡
          echo "é‡å¯WebæœåŠ¡..."
          systemctl reload nginx 2>/dev/null || true
          
          # æš‚æ—¶ä¸æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œç”¨äºè°ƒè¯•
          echo "ä¸´æ—¶æ–‡ä»¶ä¿ç•™åœ¨: $TEMP_DIR"
          echo "ä¸´æ—¶æ–‡ä»¶å†…å®¹:"
          ls -la $TEMP_DIR
          echo "ä¸´æ—¶æ–‡ä»¶å¤§å°:"
          du -sh $TEMP_DIR
          
          echo "éƒ¨ç½²å®Œæˆï¼"
          echo "æœ€ç»ˆæ£€æŸ¥éƒ¨ç½²ç›®å½•å†…å®¹ï¼š"
          ls -la $DEPLOY_PATH
          echo "è®¿é—®åœ°å€ï¼šhttp://${{ secrets.DEPLOY_HOST }}/39.105.117.48"
    
    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
        echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯ï¼š"
        echo "- åˆ†æ”¯ï¼š${{ github.ref_name }}"
        echo "- æäº¤ï¼š${{ github.sha }}"
        echo "- æäº¤è€…ï¼š${{ github.actor }}"
        echo "- éƒ¨ç½²æ—¶é—´ï¼š$(date)"
        echo "- æœåŠ¡å™¨ï¼š${{ secrets.DEPLOY_HOST }}"
        echo "ğŸŒ è®¿é—®åœ°å€ï¼šhttp://${{ secrets.DEPLOY_HOST }}/39.105.117.48"
    
    - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        echo "ğŸ“‹ å¤±è´¥ä¿¡æ¯ï¼š"
        echo "- åˆ†æ”¯ï¼š${{ github.ref_name }}"
        echo "- æäº¤ï¼š${{ github.sha }}"
        echo "- å¤±è´¥æ—¶é—´ï¼š$(date)"
        echo "ğŸ” è¯·æ£€æŸ¥ï¼š"
        echo "1. æœåŠ¡å™¨è¿æ¥æ˜¯å¦æ­£å¸¸"
        echo "2. SSHå¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®"
        echo "3. æœåŠ¡å™¨æƒé™æ˜¯å¦è¶³å¤Ÿ"
        echo "4. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
 